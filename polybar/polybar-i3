#!/usr/bin/env sh

# Terminate already running bar instances
killall -q polybar 

# Wait until the processes have been shut down
while pgrep -x polybar >/dev/null; do sleep 1; done

# Detect monitors
if command -v xrandr >/dev/null 2>&1; then

    # Get primary and secondary monitors
    PRIMARY_MONITOR=$(xrandr | grep " connected primary" | cut -d" " -f1)
    SECONDARY_MONITOR=$(xrandr | grep " connected" | grep -v "primary" | cut -d" " -f1 | head -n1)
    
    # Set environment variables
    export MONITOR_PRIMARY=${PRIMARY_MONITOR:-DP-1}
    export MONITOR_SECONDARY=${SECONDARY_MONITOR:-HDMI-2}
    
    # Launch bars on both monitors
    if [ -n "$PRIMARY_MONITOR" ]; then
        echo "Launching main bar on $PRIMARY_MONITOR"
        MONITOR_PRIMARY=$PRIMARY_MONITOR polybar -c ~/.config/i3/polybar/config.ini main &
    fi
    
    if [ -n "$SECONDARY_MONITOR" ]; then
        echo "Launching secondary bar on $SECONDARY_MONITOR"
        MONITOR_SECONDARY=$SECONDARY_MONITOR polybar -c ~/.config/i3/polybar/config.ini secondary &
    fi
else
    # Fallback to single monitor
    echo "xrandr not found, launching single bar"
    polybar -c ~/.config/i3/polybar/config.ini main &
fi
